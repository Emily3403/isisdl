#!/usr/bin/env python3
from getpass import getpass
from typing import Union, Set

from crontab import CronTab

from isisdl.backend.crypt import encryptor
from isisdl.backend.database_helper import config_helper
from isisdl.share.settings import is_first_time, env_var_name_username, env_var_name_password, is_windows


def get_input(message: str, allowed: Set[str]) -> str:
    while True:
        choice = input(message)
        if choice in allowed:
            break

        print("\nI did not quite catch that.")

    return choice


def main() -> None:
    if is_first_time or True:
        print("""It seams as if this is your first time executing isisdl. Welcome <3

I will guide you through ~2min of configuration.
There are some powerful features in this library that are opt-in.
Please read the prompts carefully.

You can re-configure me with `isisdl-config`.
""")

    print(f"""Authentication:

There are four ways of storing your password. 
  1. Encrypted in the database
       You will have to enter your password every time.
       
  2. Clear text in the database
       No password required, but less security
  
  3. Set username and password via environment variables
       Username = {env_var_name_username} 
       Password = {env_var_name_password}

  4. Manually entering the information every time
       Most secure, but also most annoying
       """)

    config_helper.delete_config()

    # choice = get_input("Please choose the way of authentication: ", {"1", "2", "3", "4"})
    choice = "3"
    config_helper.set_how_user_is_stored(int(choice))

    if choice in {"1", "2"}:
        print("Please provide authentication for ISIS.")
        username = input("Username (ISIS): ")
        password: Union[str, bytes] = getpass("Password (ISIS): ")
        if choice == "1":
            enc_password = getpass("Password (Encrypt): ")
            password = encryptor(enc_password, password)

        config_helper.set_user(username, password)

    else:
        print("Alright, no passwords will be stored.")

    #    Which mode of file name conversion?
    print(r"""For some applications the file name is important.
Some programming languages have restrictions / inconveniences when working with specific characters.
To combat this you may want to enable a specific file name scheme.

If you already have existing files they will be renamed automatically 
and transparently with the next startup of `isisdl`.

    1. No replacing.
         All characters are left as they are.
    
    2. Replace and filter not unix safe chars 
         "ä" → "ae"
         "ö" → "oe"
         "ü" → "ue"
         "/\t\n\r\v\f" → "-"
    
    3. Replace all non-url safe characters
         "#%&/:;<=>@\^`|~-$" → "."
         "[]{}" → "()"
    """)

    # choice = get_input("Please choose the file naming scheme: ", {"1", "2", "3"})
    choice = "3"

    config_helper.set_filename_scheme(int(choice))

    print("""If you wish you can throttle your download speed to a limit.
Do you want to do so?

    1. Yes
    2. No
    """)

    # choice = get_input("", {"1", "2"})
    choice = "2"
    if choice == "1":
        while True:
            amount = input("How many MiB/s am I allowed to consume? ")

            try:
                int(amount)
                break
            except ValueError:
                print("\nI did not quite catch that")

    if not is_windows:
        print("""[Linux only]
Do you want me to schedule a Cron-Job to run `isisdl` every x hours?

    1. No
    2. 1 Hour
    3. 24 Hours
        """)

        choice = get_input("", {"1", "2", "3"})
        # choice = "2"
        with CronTab(user=True) as cron:

            command = next(cron.find_command("isisdl"), None)
            if command:
                print("It seams as if isisdl is already configured to run as a Cron-Job.")
                if choice == "1":
                    second = get_input("Should I remove the entry? [y/n] ", {"y", "n"})
                    if second == "y":
                        cron.remove(command)
                else:
                    cron.remove(command)

            if choice in {"2", "3"}:
                import isisdl.__main__ as __main__
                job = cron.new(__main__.__file__, f"isisdl autogenerated", user=True)

                if choice == "2":
                    job.setall("@hourly")
                else:
                    job.setall("@daily")

                print()

    # ISIS Dir

    # Black / Whitelist

    # Telemetry Data



if __name__ == '__main__':
    main()
